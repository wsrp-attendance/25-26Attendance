<!DOCTYPE html>
<html>
<head>
  <title>WSRP Location Check-In</title>
  <style>
    /* Spinner animation */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    #spinner {
      width: 40px;
      height: 40px;
      border: 5px solid #ccc;
      border-top-color: #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 10px auto 20px auto;
      display: none;
    }
  </style>
  <script>
    const schoolLat = 42.06099;
    const schoolLng = -87.94404;
    const maxDistanceMeters = 100;
    
    // Generate a unique ID for this user session
    const uid = 'uid-' + Date.now() + '-' + Math.random().toString(36).substring(2, 8);
    
    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }
    
    function checkLocationAndInjectForms() {
      const status = document.getElementById("status");
      const spinner = document.getElementById("spinner");
      const visibleForm = document.getElementById("visibleForm");

      status.textContent = "Checking your location...";
      spinner.style.display = "block";

      if (!navigator.geolocation) {
        spinner.style.display = "none";
        status.textContent = "Geolocation is not supported by your browser.";
        return;
      }

      navigator.geolocation.getCurrentPosition(position => {
        const { latitude, longitude } = position.coords;
        const distance = haversine(latitude, longitude, schoolLat, schoolLng);
        spinner.style.display = "none";

        if (distance <= maxDistanceMeters) {
          status.textContent = "You are on school grounds. Please complete the form.";

          // Visible Form URL with UID prefilled
          const visibleFormURL = "https://docs.google.com/forms/d/e/1FAIpQLSfEX1DbIRA3BePUu94qDiZqy5ho2m6pkoVCLIcCAAdOE7osZA/viewform" +
            "?entry.1958119656=" + encodeURIComponent(uid);
          visibleForm.src = visibleFormURL;
          visibleForm.style.display = "block";

          // Hidden Form submission URL (just GET with parameters)
          const hiddenFormURL = "https://docs.google.com/forms/d/e/1FAIpQLSey9ENixvSepj6ac5cLKZ7OKlcg0lf45sJDQ9q35j40L9H8BQ/formResponse" +
            "?entry.1366409067=" + encodeURIComponent(latitude) +
            "&entry.37670907=" + encodeURIComponent(longitude) +
            "&entry.185482874=" + encodeURIComponent(uid);
          const hiddenFrame = document.createElement("iframe");
          hiddenFrame.style.display = "none";
          hiddenFrame.src = hiddenFormURL;
          document.body.appendChild(hiddenFrame);

        } else {
          status.textContent = "You are not on school grounds. Form access denied.";
        }
      }, err => {
        spinner.style.display = "none";
        status.textContent = "Unable to retrieve location: " + err.message;
      }, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      });
    }

    document.addEventListener("DOMContentLoaded", checkLocationAndInjectForms);
  </script>
</head>
<body>
  <h2>WSRP Check-In</h2>
  <p id="status">Initializing...</p>
  <div id="spinner"></div>
  <iframe id="visibleForm" width="100%" height="800" style="display:none;border:none;"></iframe>
</body>
</html>
