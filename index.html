<!DOCTYPE html>
<html>
<head>
  <title>Location-Based Form Access with GPS Capture</title>
  <style>
    #retryBtn {
      margin-top: 10px;
      cursor: pointer;
      padding: 6px 12px;
      font-size: 14px;
      display: none;
    }
    .spinner {
      margin: 10px auto 20px auto;
      width: 40px;
      height: 40px;
      border: 5px solid #ccc;
      border-top-color: #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    #errorDetails {
      display: none;
      margin-top: 8px;
      font-family: monospace;
      font-size: 0.9em;
      background: #f8f8f8;
      border: 1px solid #ddd;
      padding: 8px;
      white-space: pre-wrap;
      max-height: 150px;
      overflow-y: auto;
      border-radius: 4px;
    }
    #toggleDetails {
      color: #007bff;
      cursor: pointer;
      user-select: none;
      text-decoration: underline;
      font-size: 0.9em;
      margin-top: 8px;
      display: inline-block;
    }
  </style>
  <script>
    const schoolLat = 42.06099;
    const schoolLng = -87.94404;
    const maxDistanceMeters = 100;

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371000; // meters
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Simple UID generator - returns string like 'UID-xxxxxxxxxx'
    function generateUID() {
      return 'UID-' + Math.random().toString(36).substring(2, 12);
    }

    function toggleErrorDetails() {
      const details = document.getElementById('errorDetails');
      const toggle = document.getElementById('toggleDetails');
      if (details.style.display === 'none') {
        details.style.display = 'block';
        toggle.textContent = 'Hide Details ▲';
      } else {
        details.style.display = 'none';
        toggle.textContent = 'Show Details ▼';
      }
    }

    function submitHiddenForm(uid, lat, lng) {
      const hiddenFormAction = "https://docs.google.com/forms/d/e/1FAIpQLSey9ENixvSepj6ac5cLKZ7OKlcg0lf45sJDQ9q35j40L9H8BQ/formResponse";

      const fields = {
        "entry.185482874": uid,
        "entry.1366409067": lat,
        "entry.376709078": lng
      };

      const form = document.createElement("form");
      form.method = "POST";
      form.action = hiddenFormAction;
      form.style.display = "none";

      for (const [key, value] of Object.entries(fields)) {
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = key;
        input.value = value;
        form.appendChild(input);
      }

      document.body.appendChild(form);
      form.submit();
      setTimeout(() => form.remove(), 1000);
    }

    async function checkLocationAndLoadForm() {
      const status = document.getElementById("status");
      const formFrame = document.getElementById("form");
      const retryBtn = document.getElementById("retryBtn");
      const spinner = document.getElementById("spinner");
      const errorDetails = document.getElementById("errorDetails");
      const toggleDetails = document.getElementById("toggleDetails");

      // Reset UI
      formFrame.style.display = "none";
      retryBtn.style.display = "none";
      errorDetails.style.display = "none";
      toggleDetails.style.display = "none";
      status.textContent = "Checking your location...";
      spinner.style.display = "block";

      if (!navigator.geolocation) {
        spinner.style.display = "none";
        status.textContent = "Geolocation is not supported by your browser.";
        retryBtn.style.display = "inline-block";
        return;
      }

      try {
        const permission = await navigator.permissions.query({ name: 'geolocation' });
        if (permission.state === 'denied') {
          spinner.style.display = "none";
          status.innerHTML = "Location permission is blocked. Please enable it in your browser settings and reload the page.";
          retryBtn.style.display = "inline-block";
          return;
        }
      } catch (e) {
        // Permissions API not supported, continue
      }

      navigator.geolocation.getCurrentPosition(
        position => {
          spinner.style.display = "none";

          const { latitude, longitude } = position.coords;
          const distance = haversine(latitude, longitude, schoolLat, schoolLng);

          if (distance <= maxDistanceMeters) {
            const uid = generateUID();

            // Submit hidden form with UID + GPS
            submitHiddenForm(uid, latitude, longitude);

            status.textContent = "Location verified. Welcome! You may complete the form.";

            // Append UID as query param for user to fill visible form (optional)
            // If your visible form has a UID field, prefill URL like:
            // const visibleFormURL = `https://docs.google.com/forms/d/e/1FAIpQLSfEX1DbIRA3BePUu94qDiZqy5ho2m6pkoVCLIcCAAdOE7osZA/viewform?entry.1958119656=${encodeURIComponent(uid)}`;

            // For now, just load form normally:
            formFrame.style.display = "block";
          } else {
            status.textContent = "You are not on school grounds. Form access is restricted.";
            retryBtn.style.display = "inline-block";
          }
        },
        error => {
          spinner.style.display = "none";

          let friendlyMessage = "An unknown error occurred while retrieving your location.";
          let detailsMessage = `Error code: ${error.code}\nMessage: ${error.message}`;

          switch (error.code) {
            case error.PERMISSION_DENIED:
              friendlyMessage = "Location permission denied. Please allow access and reload the page.";
              break;
            case error.POSITION_UNAVAILABLE:
              friendlyMessage = "Location information is unavailable. Try again later.";
              break;
            case error.TIMEOUT:
              friendlyMessage = "Location request timed out. Please retry.";
              break;
          }

          if (error.code === error.PERMISSION_DENIED) {
            status.innerHTML = `${friendlyMessage}<br><br><b>Tip:</b> Check your browser's site settings.`;
          } else {
            status.textContent = friendlyMessage;
          }

          retryBtn.style.display = "inline-block";

          errorDetails.textContent = detailsMessage;
          errorDetails.style.display = "none";
          toggleDetails.style.display = "inline-block";
          toggleDetails.textContent = "Show Details ▼";

          console.error("Geolocation error:", error);
        },
        { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
      );
    }
  </script>
</head>
<body>
  <h2>WSRP Student/Mentor Check-In</h2>

  <p id="status" aria-live="polite">Checking your location...</p>

  <div id="spinner" class="spinner" style="display:none"></div>

  <button id="retryBtn" onclick="location.reload()">Retry Location Check</button>

  <span id="toggleDetails" onclick="toggleErrorDetails()" style="display:none" role="button" tabindex="0" aria-pressed="false" aria-label="Toggle detailed error message"></span>

  <pre id="errorDetails"></pre>

  <iframe
    id="form"
    src="https://docs.google.com/forms/d/e/1FAIpQLSfEX1DbIRA3BePUu94qDiZqy5ho2m6pkoVCLIcCAAdOE7osZA/viewform"
    width="100%"
    height="800"
    frameborder="0"
    style="display:none"
  ></iframe>

  <script>
    document.addEventListener("DOMContentLoaded", checkLocationAndLoadForm);
  </script>
</body>
</html>
